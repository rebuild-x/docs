<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>rebuild-x Documentation</title>
    <link rel="icon" href="./images/favicon.ico" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- External style links -->
    <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/docsify-darklight-theme@latest/dist/style.min.css" />
    <link rel="stylesheet" href="./css/likes-comments.css" />
    <link rel="stylesheet" href="./css/style.css" />
    
    <!-- Inline Critical Styles -->
    <style>
      nav.app-nav li ul {
        min-width: 100px;
      }

      :root {
        --accent: #42b983;
        --background: #091a28;
        --textColor: #b4b4b4;
        --codeTextColor: #ffffff;
        --codeBackgroundColor: #0e2233;
        --borderColor: #0d2538;
        --blockQuoteColour: #858585;
        --highlightColor: #d22778;
        --sidebarSublink: #b4b4b4;
        --codeTypeColor: #ffffff;
        --coverBackground: linear-gradient(to left bottom, hsl(118, 100%, 85%) 0%, hsl(181, 100%, 85%) 100%);
        --siteFont: "PT Sans";
        --codeFontFamily: "Roboto Mono, Monaco, courier, monospace";
        --bodyFontSize: "17px";
        color-scheme: dark;
      }

      #docsify-darklight-theme {
        display: none;
      }
    </style>

  </head>
  <body>
    <div id="app">We are building something special for you...</div>

    <!-- Docsify Configuration -->
    <script>
      window.$docsify = {
        search: 'auto',
        repo: 'https://github.com/rebuild-x/rebuild-x',
        plugins: [
          function(hook) {
            var footer = [
              '<footer style="text-align: center; margin-top: 0px;">',
              '<div align="center">',
              '<img src="https://raw.githubusercontent.com/maysara-elshewehy/SuperZIG-assets/refs/heads/main/dist/img/md/line.png" alt="decorative line" style="display: block; margin-top:0px; margin-bottom:20px; width:500px;"/>',
              '</div>',
              '<br>',
              '<div align="center">',
              '<a href="https://github.com/maysara-elshewehy">',
              '<img src="https://img.shields.io/badge/Made with ❤️ by-Maysara-orange" alt="Made with love by Maysara"/>',
              '</a>',
              '</div>',
              '</footer>'
            ].join('');

            hook.afterEach(function(html) {
              return html + footer;
            });
          }
        ],
        auto2top: true,
        executeScript: true,
        loadSidebar: true,
        loadNavbar: true,
        maxLevel: 4,
        subMaxLevel: 3,
        name: 'rebuild-x Documentation',
        search: {
          noData: {
            '/': 'No results!'
          },
          paths: 'auto',
          placeholder: {
            '/': 'Search'
          }
        },
        formatUpdated: '{MM}/{DD} {HH}:{mm}',
      };
    </script>

    <!-- External Scripts -->
    <script src="//cdn.jsdelivr.net/npm/docsify/lib/docsify.min.js"></script>
    <script src="//cdn.jsdelivr.net/npm/docsify/lib/plugins/search.min.js"></script>
    <script src="//cdn.jsdelivr.net/npm/prismjs/components/prism-bash.min.js"></script>
    <script src="//cdn.jsdelivr.net/npm/prismjs/components/prism-markdown.min.js"></script>
    <script src="//cdn.jsdelivr.net/npm/prismjs/components/prism-zig.min.js"></script>
    <script src="//cdn.jsdelivr.net/npm/docsify-pagination/dist/docsify-pagination.min.js"></script>

    <!-- Likes and comments functionality -->
    <script>
      // Backend base URL
      const backendBase = "https://rebuild-x.maysara.xyz";

      // Get pageId based on the current page link
      function getPageId() {
        let path = window.location.hash.slice(2) || '/';
        return path.replace(/\//g, '_').replace(/\./g, '_');
      }

      // Function to update likes count via the backend
      async function updateLikes() {
        const pageId = getPageId();
        try {
          const res = await fetch(`${backendBase}/api/likes/${pageId}`);
          const data = await res.json();
          const likeCount = document.getElementById('like-count');
          if (likeCount) likeCount.textContent = data.count;
        } catch (error) {
          console.error("Error fetching likes count:", error);
        }
      }

      // Update comments section
      async function updateComments() {
        const pageId = getPageId();
        try {
          const res = await fetch(`${backendBase}/api/comments/${pageId}`);
          const comments = await res.json();
          const commentsContainer = document.getElementById('user-comments-container');
          if (commentsContainer) {
            commentsContainer.innerHTML = '';
            if (!comments || Object.keys(comments).length === 0) {
              commentsContainer.innerHTML = '<p>No comments yet.</p>';
            } else {
              Object.keys(comments).forEach((commentId) => {
                const comment = comments[commentId];
                let dateStr = comment.timestamp ? new Date(comment.timestamp).toLocaleString() : 'Now';
                const div = document.createElement('div');
                div.className = 'user-comment';
                div.innerHTML = `
                  <div class="user-comment-meta">
                    <img class="user-comment-avatar" src="${comment.photoURL || './images/default-avatar.png'}" alt="User picture">
                    <span class="user-comment-author">${comment.name || 'Anonymous'}</span>
                    <span class="user-comment-date">${dateStr}</span>
                  </div>
                  <div class="user-comment-content">${comment.text}</div>
                `;
                commentsContainer.appendChild(div);
              });
            }
          }
        } catch (error) {
          console.error("Error fetching comments:", error);
        }
      }

      // Handle like action via the backend
      async function toggleLike() {
        const pageId = getPageId();
        try {
          const res = await fetch(`${backendBase}/api/likes/${pageId}/toggle`, {
            method: "POST",
            credentials: 'include',
            headers: {
              "Content-Type": "application/json"
            }
          });
          if (res.status === 401) {
            window.location.href = `${backendBase}/auth/github`;
            return;
          }
          const data = await res.json();
          console.log("Like toggle result:", data);
          updateLikes();
        } catch (error) {
          console.error("Error toggling like state:", error);
        }
      }

      // Post a comment via the backend
      async function postComment() {
        const pageId = getPageId();
        const commentText = document.getElementById('user-comment-text');
        if (!commentText || !commentText.value.trim()) {
          alert("Comment cannot be empty.");
          return;
        }
        try {
          const res = await fetch(`${backendBase}/api/comments/${pageId}`, {
            method: "POST",
            credentials: 'include',
            headers: {
              "Content-Type": "application/json"
            },
            body: JSON.stringify({ text: commentText.value.trim() })
          });
          if (res.status === 401) {
            window.location.href = `${backendBase}/auth/github`;
            return;
          }
          const data = await res.json();
          console.log("Comment post result:", data);
          commentText.value = "";
          updateComments();
        } catch (error) {
          console.error("Error posting comment:", error);
        }
      }

      // Add interaction interface
      (function () {
        const plugin = (hook, vm) => {
          hook.afterEach(function (html, next) {
            const likeCommentSection = `
              <div class="page-interactions">
                <div class="like-section">
                  <button id="like-button" aria-label="Like">
                    <span id="like-icon">❤️</span>
                    <span id="like-count">0</span>
                  </button>
                </div>
                <div class="user-comment-section">
                  <h3>Comments</h3>
                  <div id="user-comments-container"></div>
                  <div class="user-comment-form">
                    <textarea id="user-comment-text" placeholder="Sign in to comment"></textarea>
                    <button id="user-comment-submit">Sign in to Comment</button>
                  </div>
                </div>
              </div>
            `;
            next(html + likeCommentSection);

            setTimeout(() => {
              const likeButton = document.getElementById("like-button");
              const commentSubmit = document.getElementById("user-comment-submit");

              if (likeButton) {
                likeButton.addEventListener("click", toggleLike);
              }
              if (commentSubmit) {
                commentSubmit.addEventListener("click", postComment);
              }
              updateLikes();
              updateComments();

              // Check auth status
              fetch(`${backendBase}/auth/status`, {
                credentials: 'include'
              })
              .then(res => res.json())
              .then(data => {
                const commentText = document.getElementById('user-comment-text');
                const commentSubmit = document.getElementById('user-comment-submit');
                if (data.authenticated) {
                  commentText.placeholder = "Write your comment here...";
                  commentSubmit.textContent = "Submit Comment";
                } else {
                  commentText.placeholder = "Sign in to comment...";
                  commentSubmit.textContent = "Sign in to Comment";
                }
              })
              .catch(console.error);
            }, 100);
          });
        };
        window.$docsify.plugins = [].concat(plugin, window.$docsify.plugins);
      })();
    </script>
  </body>
</html>